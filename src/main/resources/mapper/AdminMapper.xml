<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.review.shop.repository.admin.AdminMapper">

    <insert id="insertProduct" parameterType="com.review.shop.dto.product.ProductDetailDTO"
            useGeneratedKeys="true"
            keyProperty="product_id"
            keyColumn="PRODUCT_ID">
        INSERT INTO PRODUCT (
            PRD_NAME, PRD_BRAND, INGREDIENT, PRICE, CATEGORY,
            STOCK, RATING, DESCRIPTION, REVIEW_COUNT, BAUMANN_ID
        )
        VALUES (
                   #{prd_name},
                   #{prd_brand},
                   #{ingredient},
                   #{price},
                   #{category},
                   #{stock},
                   #{rating},
                   #{description},
                   #{review_count},
                   #{baumann_id}
               )
    </insert>

    <update id="updateProduct">
        UPDATE PRODUCT
        SET
            PRD_NAME      = #{product.prd_name},
            PRD_BRAND     = #{product.prd_brand},
            INGREDIENT    = #{product.ingredient},
            PRICE         = #{product.price},
            CATEGORY      = #{product.category},
            STOCK         = #{product.stock},
            RATING        = #{product.rating},
            DESCRIPTION   = #{product.description},
            REVIEW_COUNT  = #{product.review_count},
            BAUMANN_ID    = #{product.baumann_id},
            IS_SOLD_OUT   = #{product.is_sold_out},
            UPDATED_AT    = SYSDATE
        WHERE
            PRODUCT_ID    = #{productId}
    </update>

    <update id="deleteProduct">
        UPDATE PRODUCT
        SET DELETED_AT = SYSDATE
        WHERE PRODUCT_ID = #{productId}
    </update>

    <update id="updateOrderStatus">
        UPDATE ORDERS
        SET ORDER_STATUS = #{orderStatus}
        WHERE ORDER_ID = #{orderId}
    </update>

    <update id="updateQnaAnswer">
        UPDATE QNA
        SET
            ANSWER = #{adminAnswer},
            ANSWERED_AT = SYSDATE
        WHERE
            QNA_ID = #{qnaId}
    </update>

    <select id="getMemberPoints" resultType="java.lang.Integer">
        SELECT POINT FROM USER_TABLE WHERE USER_ID = #{memberId}
    </select>

    <select id="getAllProducts" resultType="com.review.shop.dto.product.ProductDetailDTO">
        SELECT
            P.PRODUCT_ID,
            P.PRD_NAME,
            P.PRD_BRAND,
            P.INGREDIENT,
            P.PRICE,
            P.CATEGORY,
            P.STOCK,
            P.RATING,
            P.DESCRIPTION,
            P.REVIEW_COUNT,
            P.BAUMANN_ID,
            P.IS_SOLD_OUT,
            P.CREATED_AT,
            P.UPDATED_AT,
            P.DELETED_AT,
            (
                SELECT LISTAGG(PI.IMAGE_URL, ',') WITHIN GROUP (ORDER BY PI.PRD_IMG_ID)
        FROM PRODUCT_IMAGE PI
        WHERE PI.PRODUCT_ID = P.PRODUCT_ID
            ) AS product_image
        FROM
            PRODUCT P
        WHERE
            P.DELETED_AT IS NULL
    </select>

    <update id="deleteReview" parameterType="int">
        UPDATE REVIEW
        SET DELETED_AT = SYSDATE
        WHERE REVIEW_ID = #{reviewId}
    </update>

    <update id="setReviewSelection">
        UPDATE REVIEW
        SET IS_SELECTED = #{isSelected}
        WHERE REVIEW_ID = #{reviewId}
    </update>

    <select id="getAllQna" resultType="com.review.shop.dto.qna.QnAListDTO">
        SELECT
            q.QNA_ID    AS qna_id,
            q.TITLE     AS title,
            u.NAME      AS user_name
        FROM QNA q
                 JOIN USER_TABLE u ON q.USER_ID = u.USER_ID
        WHERE q.DELETED_AT IS NULL
        ORDER BY q.QNA_ID DESC
    </select>

    <select id="getQnaDetail" parameterType="int" resultType="com.review.shop.dto.qna.QnaDTO">
        SELECT
            q.QNA_ID,
            q.PRODUCT_ID,
            q.USER_ID,
            q.TITLE,
            q.CONTENT,
            q.ANSWER,
            q.CREATED_AT,
            q.ANSWERED_AT,
            q.DELETED_AT,
            u.NAME AS user_name,
            CASE
                WHEN q.ANSWER IS NOT NULL THEN '답변완료'
                ELSE '답변대기'
                END AS status
        FROM QNA q
                 LEFT JOIN USER_TABLE u ON q.USER_ID = u.USER_ID
                 LEFT JOIN PRODUCT p ON q.PRODUCT_ID = p.PRODUCT_ID
        WHERE q.QNA_ID = #{qnaId}
    </select>


    <update id="updateMemberPoints">
        UPDATE USER_TABLE
        SET
            POINT = #{points},
            UPDATED_AT = SYSDATE
        WHERE
            USER_ID = #{userId}
    </update>
</mapper>