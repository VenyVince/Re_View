<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.review.shop.repository.review.ReviewMapper">

    <select id="selectReviewList" resultType="com.review.shop.dto.review.ReviewDTO">
        SELECT
        r.review_id,
        COALESCE(u.nickname, u.name) AS writer,
        TO_CHAR(r.created_at, 'YYYY-MM-DD') AS created_at,
        ri.image_url,
        p.prd_brand AS brand_name,
        p.prd_name AS product_name,
        COALESCE(r.like_count, 0) AS like_count,
        p.price,
        r.content,
        r.rating,
        r.is_selected,
        r.is_checked,
        -- 상품 썸네일 가져오기 (서브쿼리)
        (SELECT image_url
        FROM product_image
        WHERE product_id = p.product_id
        AND is_thumbnail = 'Y'
        AND ROWNUM = 1) AS product_image
        FROM review r
        JOIN USER_table u ON r.user_id = u.user_id
        JOIN product p ON r.product_id = p.product_id
        -- 리뷰 이미지 중 첫 번째 것만 가져오기 (1:1 매핑 효과)
        LEFT JOIN (
        SELECT review_id, image_url,
        ROW_NUMBER() OVER (PARTITION BY review_id ORDER BY review_image_id) AS rn
        FROM review_images
        ) ri ON r.review_id = ri.review_id AND ri.rn = 1
        WHERE r.deleted_at IS NULL

        <if test="category != null and category != ''">
            AND p.category = #{category}
        </if>

        <choose>
            <when test="sort == 'latest'">
                ORDER BY r.created_at DESC
            </when>
            <when test="sort == 'oldest'">
                ORDER BY r.created_at ASC
            </when>
            <when test="sort == 'high_rating'">
                ORDER BY r.rating DESC
            </when>
            <when test="sort == 'low_rating'">
                ORDER BY r.rating ASC
            </when>
            <when test="sort == 'likes'">
                ORDER BY r.like_count DESC
            </when>
            <when test="sort == 'dislikes'">
                ORDER BY r.dislike_count DESC
            </when>
            <otherwise>
                ORDER BY r.like_count DESC, r.created_at DESC
            </otherwise>
        </choose>

        OFFSET #{offset} ROWS
        FETCH NEXT #{size} ROWS ONLY
    </select>

    <select id="getReviewBase" resultType="com.review.shop.dto.review.ReviewDetailResponseDTO$ReviewDetailDTO">
        SELECT
        r.review_id,
        r.product_id,
        u.nickname,
        b.type AS baumann_type,
        r.rating,
        r.content,
        TO_CHAR(r.created_at, 'YYYY-MM-DD') as created_at,
        r.like_count,
        r.dislike_count
        FROM review r
        JOIN USER_TABLE u ON r.user_id = u.user_id
        LEFT JOIN baumann b ON u.baumann_id = b.baumann_id
        WHERE r.review_id = #{review_id}
    </select>

    <select id="getProductByReviewId" resultType="com.review.shop.dto.review.ReviewDetailResponseDTO$ProductInfoDTO">
        SELECT
        p.product_id,
        p.prd_name,
        p.prd_brand,
        p.price,
        p.category,
        (SELECT image_url FROM product_image WHERE product_id = p.product_id AND ROWNUM = 1) as product_image
        FROM review r
        JOIN product p ON r.product_id = p.product_id
        WHERE r.review_id = #{review_id}
    </select>

    <select id="getReviewImages" resultType="string">
        SELECT image_url
        FROM review_images
        WHERE review_id = #{review_id}
    </select>

    <select id="getComments" resultType="com.review.shop.dto.review.ReviewDetailResponseDTO$CommentDTO">
        SELECT
        c.review_comment_id as comment_id,
        u.nickname,
        c.content,
        TO_CHAR(c.created_at, 'YYYY-MM-DD') as created_at
        FROM review_comment c
        JOIN USER_TABLE u ON c.user_id = u.user_id
        WHERE c.review_id = #{review_id}
        and c.deleted_at is null
        ORDER BY c.created_at ASC
    </select>

    <select id="getUserReaction" resultType="string">
        SELECT is_like
        FROM REVIEW_LIKE
        WHERE review_id = #{review_id}
        AND user_id = #{user_id}
    </select>
</mapper>