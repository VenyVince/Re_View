<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.review.shop.repository.review.ReviewMapper">

    <!-- 리뷰 목록 조회 (JOIN 포함) -->
    <select id="selectReviewList" resultType="com.review.shop.dto.review.ReviewDTO">
        SELECT
        r.review_id,
        COALESCE(u.nickname, u.name) AS writer,
        TO_CHAR(r.created_at, 'YYYY-MM-DD') AS created_at,
        ri.image_url,
        p.prd_brand AS brand_name,
        p.prd_name AS product_name,
        COALESCE(r.like_count, 0) AS like_count,
        p.price,
        r.content,
        r.rating
        FROM review r
        JOIN USER_table u ON r.user_id = u.user_id
        JOIN product p ON r.product_id = p.product_id
        LEFT JOIN (
        SELECT review_id, image_url,
        ROW_NUMBER() OVER (PARTITION BY review_id ORDER BY review_image_id) AS rn
        FROM review_images
        ) ri ON r.review_id = ri.review_id AND ri.rn = 1
        WHERE r.deleted_at IS NULL
        <choose>
            <when test="sort == 'latest'">
                ORDER BY r.created_at DESC
            </when>
            <when test="sort == 'rating'">
                ORDER BY r.rating DESC, r.created_at DESC
            </when>
            <otherwise>
                ORDER BY r.like_count DESC, r.created_at DESC
            </otherwise>
        </choose>
        OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
    </select>
</mapper>