<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.review.shop.repository.product.ProductReviewMapper">

    <!-- 특정 상품의 리뷰 목록 조회 (이미지 포함, 평탄한 구조) -->
    <select id="selectReviewsByProduct" resultType="com.review.shop.dto.product.ProductReviewDTO">
        SELECT
        r.review_id,
        r.content,
        r.rating,
        r.like_count,
        r.dislike_count,
        TO_CHAR(r.created_at, 'YYYY-MM-DD') AS created_at,
        COALESCE(r.is_selected, '0') AS is_selected,
        u.user_id,
        u.nickname,
        u.baumann_id,
        b.type AS baumann_type,
        ri.image_url
        FROM review r
        JOIN USER_TABLE u ON r.user_id = u.user_id
        LEFT JOIN baumann b ON u.baumann_id = b.baumann_id
        LEFT JOIN review_images ri ON r.review_id = ri.review_id
        WHERE r.product_id = #{productId}
        AND r.deleted_at IS NULL
        <choose>
            <when test="sort == 'latest'">
                ORDER BY r.created_at DESC, r.review_id DESC
            </when>
            <when test="sort == 'rating'">
                ORDER BY r.rating DESC, r.created_at DESC, r.review_id DESC
            </when>
            <otherwise>
                ORDER BY r.like_count DESC, r.created_at DESC, r.review_id DESC
            </otherwise>
        </choose>
    </select>

    <!-- 리뷰 생성 -->
    <insert id="insertReview" useGeneratedKeys="true" keyProperty="review_id">
        INSERT INTO review (product_id, user_id, content, rating, created_at)
        VALUES (#{productId}, #{userId}, #{content}, #{rating}, SYSDATE)
    </insert>

    <!-- 리뷰 이미지 저장 -->
    <insert id="insertReviewImage">
        INSERT INTO review_images (review_id, image_url)
        VALUES (#{reviewId}, #{imageUrl})
    </insert>

    <!-- 가장 최근 생성된 리뷰 조회 -->
    <select id="selectLastReview" resultType="com.review.shop.dto.product.ProductReviewDTO">
        SELECT
        r.review_id,
        r.content,
        r.rating,
        r.like_count,
        r.dislike_count,
        TO_CHAR(r.created_at, 'YYYY-MM-DD') AS created_at,
        COALESCE(r.is_selected, '0') AS is_selected,
        u.user_id,
        u.nickname,
        u.baumann_id,
        b.type AS baumann_type,
        ri.image_url
        FROM review r
        JOIN USER_TABLE u ON r.user_id = u.user_id
        LEFT JOIN baumann b ON u.baumann_id = b.baumann_id
        LEFT JOIN review_images ri ON r.review_id = ri.review_id
        WHERE r.product_id = #{productId}
        AND r.user_id = #{userId}
        AND r.deleted_at IS NULL
        ORDER BY r.review_id DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

</mapper>