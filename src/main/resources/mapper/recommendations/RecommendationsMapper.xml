<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.review.shop.repository.recommendations.RecommendationsMapper">

        <!--  1. 사용자의 바우만 타입 조회  -->
    <select id="getBaumannTypeByUserId" parameterType="int" resultType="Integer">
        SELECT BAUMANN_ID FROM USER_TABLE WHERE user_id = #{user_id}
    </select>
    <select id="getBaumannDTOWithId" parameterType="integer" resultType="com.review.shop.dto.recommendations.BaumannDTO">
        SELECT FIRST, SECOND, THIRD, FOURTH FROM BAUMANN WHERE BAUMANN_ID = #{user_Baumann}
    </select>

    <!-- 2. 공통 SQL -->
    <sql id="productSelectColumns">
        p.product_id, p.prd_name, p.prd_brand, p.price, p.rating, p.review_count,
        pi.image_url AS product_image_url
    </sql>

    <sql id="productImageJoin">
        LEFT JOIN LATERAL ( SELECT image_url FROM PRODUCT_IMAGE WHERE product_id = p.product_id AND is_thumbnail = 'Y' FETCH FIRST 1 ROWS ONLY ) pi ON 1 = 1
    </sql>


    <!-- 상품 추천 점수 -->
    <sql id="productBaumannScore">
        (
            (CASE WHEN pb.FIRST  = #{userInfo[0]} THEN 30 WHEN pb.FIRST  IS NULL THEN 10 ELSE 0 END) +
            (CASE WHEN pb.SECOND = #{userInfo[1]} THEN 30 WHEN pb.SECOND IS NULL THEN 10 ELSE 0 END) +
            (CASE WHEN pb.THIRD  = #{userInfo[2]} THEN 30 WHEN pb.THIRD  IS NULL THEN 10 ELSE 0 END) +
            (CASE WHEN pb.FOURTH = #{userInfo[3]} THEN 30 WHEN pb.FOURTH IS NULL THEN 10 ELSE 0 END)
        )
    </sql>

    <sql id="productReviewCountScore">
        CASE
            WHEN p.review_count >= 50 THEN 30 WHEN p.review_count >= 30 THEN 20 WHEN p.review_count >= 10 THEN 10 ELSE 0
        END
    </sql>


    <!-- 3. 상품 추천 -->
    <select id="findRecommendProducts" parameterType="java.util.List" resultType="com.review.shop.dto.recommendations.RecommendProductDTO">
        SELECT * FROM ( SELECT <include refid="productSelectColumns"/>,
            ( <include refid="productBaumannScore"/> + <include refid="productReviewCountScore"/> ) AS total_score
            FROM PRODUCT p
            JOIN BAUMANN pb ON p.baumann_id = pb.baumann_id
            <include refid="productImageJoin"/>
            )
        WHERE total_score >= 40
        ORDER BY total_score DESC, review_count DESC
        FETCH FIRST 16 ROWS ONLY

    </select>


    <!-- 리뷰 추천 점수 -->
    <sql id="reviewBaumannScore">
        (
            (CASE WHEN rb.FIRST  = #{userInfo[0]} THEN 10 ELSE 0 END) +
            (CASE WHEN rb.SECOND = #{userInfo[1]} THEN 10 ELSE 0 END) +
            (CASE WHEN rb.THIRD  = #{userInfo[2]} THEN 10 ELSE 0 END) +
            (CASE WHEN rb.FOURTH = #{userInfo[3]} THEN 10 ELSE 0 END)
        )
    </sql>

    <sql id="productBaumannMatchScore">
        (
            (CASE WHEN pb.FIRST  = #{userInfo[0]} THEN 5 WHEN pb.FIRST  IS NULL THEN 3 ELSE 0 END) +
            (CASE WHEN pb.SECOND = #{userInfo[1]} THEN 5 WHEN pb.SECOND IS NULL THEN 3 ELSE 0 END) +
            (CASE WHEN pb.THIRD  = #{userInfo[2]} THEN 5 WHEN pb.THIRD  IS NULL THEN 3 ELSE 0 END) +
            (CASE WHEN pb.FOURTH = #{userInfo[3]} THEN 5 WHEN pb.FOURTH IS NULL THEN 3 ELSE 0 END)
        )
    </sql>

    <sql id="ratingSimilarityScore">
        CASE
            WHEN ABS(r.rating - p.rating) &lt;= 0.5 THEN 10
            WHEN ABS(r.rating - p.rating) &lt;= 1.0 THEN 5
            ELSE 0
        END
    </sql>
    <!-- 리뷰 추천-->
    <select id="findRecommendReviews" parameterType="java.util.List" resultType="com.review.shop.dto.recommendations.RecommendReviewDTO">
        SELECT review_id, content, review_rating, like_count, nickname, review_image_url, product_id, prd_name, rating, is_checked, total_score
        FROM
            ( SELECT r.review_id, r.content, r.rating AS review_rating, r.like_count, r.is_checked,
                      u.nickname,
                      COALESCE(ri.image_url, pi.image_url) AS review_image_url,
                      p.product_id, p.prd_name, p.rating,
                      -- 리뷰 추천 점수계산로직
        CASE WHEN r.is_checked = 1 THEN
            (<include refid="reviewBaumannScore"/> + <include refid="productBaumannMatchScore"/> + <include refid="ratingSimilarityScore"/>) * 1.2
            ELSE
            (<include refid="reviewBaumannScore"/> + <include refid="productBaumannMatchScore"/> + <include refid="ratingSimilarityScore"/>)
            END AS total_score,
                  -- 상품당 리뷰 하나만 추천하기 위해 다시 점수
                ROW_NUMBER() OVER ( PARTITION BY p.product_id ORDER BY CASE WHEN r.is_checked = 1 THEN
                (<include refid="reviewBaumannScore"/> + <include refid="productBaumannMatchScore"/> + <include refid="ratingSimilarityScore"/>) * 1.2
                ELSE
                (<include refid="reviewBaumannScore"/> + <include refid="productBaumannMatchScore"/> + <include refid="ratingSimilarityScore"/>)
                END DESC, r.like_count DESC ) AS rn
        FROM REVIEW r
        JOIN PRODUCT p      ON r.product_id = p.product_id
        JOIN USER_TABLE u   ON r.user_id = u.user_id
            -- 작성자 바우만 타입
        JOIN BAUMANN rb     ON u.baumann_id = rb.baumann_id
            -- 상품 바우만 타입
        JOIN BAUMANN pb     ON p.baumann_id = pb.baumann_id
            -- 리뷰 이미지 없으면 상품 이미지 대신 할당
        LEFT JOIN LATERAL (
        SELECT image_url
        FROM REVIEW_IMAGES
        WHERE review_id = r.review_id
        ORDER BY review_image_id
        FETCH FIRST 1 ROWS ONLY
        ) ri ON 1 = 1
        LEFT JOIN LATERAL (
        SELECT image_url
        FROM PRODUCT_IMAGE
        WHERE product_id = p.product_id
        AND is_thumbnail = 'Y'
        FETCH FIRST 1 ROWS ONLY
        ) pi ON 1 = 1 )
        -- 상품별 1등 리뷰만 할당
        WHERE rn = 1
        ORDER BY total_score DESC, like_count DESC
        FETCH FIRST 16 ROWS ONLY

    </select>


    <!--  어드민 픽 추천  -->
    <select id="getRandomRecommendationAdminPicks" resultType="com.review.shop.dto.recommendations.RecommendationAdminPickDTO">
        SELECT
            p.product_id AS product_id, p.prd_name AS product_name, p.prd_brand AS product_brand, p.price,
            ri.image_url AS thumbnail_url,
            r.content, r.review_id,
            u.nickname, u.baumann_id
        FROM review r
                 INNER JOIN product p
                            ON r.product_id = p.product_id
                 INNER JOIN user_table u
                            ON r.user_id = u.user_id
                 LEFT JOIN LATERAL (
            SELECT image_url
            FROM review_images ri
            WHERE ri.review_id = r.review_id
            ORDER BY ri.review_image_id ASC
                FETCH FIRST 1 ROWS ONLY
                ) ri ON 1 = 1
        WHERE r.is_selected = '1'
        ORDER BY DBMS_RANDOM.VALUE
            FETCH FIRST 1 ROWS ONLY
    </select>
</mapper>